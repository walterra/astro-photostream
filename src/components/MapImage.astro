---
/**
 * MapImage component for single photo location display
 * Based on reference implementation pattern from walterra-dev
 * Uses Geoapify Static Map API for privacy-focused location display
 */

// Import consolidated CSS
import '../styles/aps-core.css';

interface Props {
  latitude: number;
  longitude: number;
  locationName?: string;
  width?: number;
  height?: number;
  zoom?: number;
  style?: string;
  class?: string;
}

const {
  latitude,
  longitude,
  locationName,
  width = 400,
  height = 300,
  zoom = 8, // Fixed zoom for privacy (as per reference)
  style = "osm-bright-smooth",
  class: className = ""
} = Astro.props;

// Geoapify API key from environment
const apiKey = import.meta.env.GEOAPIFY_API_KEY;

// Generate static map URL (aligned with reference implementation)
const mapUrl = apiKey 
  ? `https://maps.geoapify.com/v1/staticmap?style=${style}&width=${width}&height=${height}&center=lonlat:${longitude},${latitude}&zoom=${zoom}&marker=lonlat:${longitude},${latitude};color:%23ff0000;size:medium&apiKey=${apiKey}`
  : null;

// Generate alt text for accessibility
const altText = locationName 
  ? `Map showing location of ${locationName}` 
  : `Map showing location at coordinates ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
---

<div class={`aps-map-image ${className}`}>
  {mapUrl ? (
    <img
      src={mapUrl}
      alt={altText}
      width={width}
      height={height}
      class="aps-image aps-rounded-lg aps-shadow-sm"
      loading="lazy"
    />
  ) : (
    <!-- Fallback when no API key available -->
    <div 
      class="aps-placeholder aps-text-secondary aps-p-md aps-text-center"
      style={`width: ${width}px; height: ${height}px;`}
    >
      <div>
        <svg class="aps-map-icon" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
        </svg>
        <p class="aps-text-base aps-font-medium aps-mb-xs">
          {locationName || 'Location'}
        </p>
        <p class="aps-text-xs aps-text-muted">
          {latitude.toFixed(4)}, {longitude.toFixed(4)}
        </p>
      </div>
    </div>
  )}
</div>

<style>
  /* Component-specific styles that can't be utilities */
  .aps-map-image {
    display: block;
    width: fit-content;
    margin: 0 auto;
  }
  
  .aps-map-icon {
    width: 32px;
    height: 32px;
    margin: 0 auto var(--aps-space-sm);
    display: block;
    opacity: 0.7;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .aps-map-icon {
      width: 28px;
      height: 28px;
    }
  }
</style>