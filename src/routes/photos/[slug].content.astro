---
/**
 * Content-only individual photo page - for use with layout wrappers
 * Handles URLs: /photos/2018-03-10_elasticon-0001, etc.
 * Based on main photo route but extracting only content portion
 */
import { getCollection, getEntry } from 'astro:content';
import { config } from 'virtual:astro-photostream/config';
import { layoutConfig, shouldUseLayout, layoutWrapper, layoutProps } from 'virtual:astro-photostream/layout';
import PhotoCard from '../../components/PhotoCard.astro';
import MapImage from '../../components/MapImage.astro';
import type { PhotoMetadata } from '../../types.js';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = async () => {
  // Get all photos for static generation
  const allPhotos = await getCollection('photos', ({ data }) => !data.draft);
  
  // Sort photos by publish date for navigation context
  const sortedPhotos = allPhotos
    .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime());

  return sortedPhotos.map((photo, index) => {
    // Calculate previous/next photos for navigation
    const prevPhoto = sortedPhotos[index - 1] || null;
    const nextPhoto = sortedPhotos[index + 1] || null;
    
    return {
      params: { slug: photo.slug },
      props: { 
        photo,
        prevPhoto: prevPhoto ? {
          slug: prevPhoto.slug,
          title: prevPhoto.data.title,
          coverImage: prevPhoto.data.coverImage
        } : null,
        nextPhoto: nextPhoto ? {
          slug: nextPhoto.slug,
          title: nextPhoto.data.title,
          coverImage: nextPhoto.data.coverImage
        } : null,
        photoIndex: index + 1,
        totalPhotos: sortedPhotos.length,
        layoutConfig,
        layoutWrapper,
        layoutProps
      }
    };
  });
};

// Get props from static generation
const { 
  photo, 
  prevPhoto, 
  nextPhoto, 
  photoIndex, 
  totalPhotos, 
  layoutConfig: passedLayoutConfig, 
  layoutWrapper: passedLayoutWrapper, 
  layoutProps: passedLayoutProps 
} = Astro.props;

// Photo metadata
const photoMetadata: PhotoMetadata = {
  id: photo.slug,
  title: photo.data.title,
  description: photo.data.description,
  coverImage: photo.data.coverImage,
  camera: photo.data.camera,
  lens: photo.data.lens,
  settings: photo.data.settings,
  location: photo.data.location,
  tags: photo.data.tags || [],
  publishDate: new Date(photo.data.publishDate),
  draft: photo.data.draft || false
};

// Page metadata
const pageTitle = `${photo.data.title} - Photo Gallery - ${config.seo.siteName || 'Photo Stream'}`;
const pageDescription = photo.data.description 
  ? `${photo.data.description} Photo ${photoIndex} of ${totalPhotos}.`
  : `Photo ${photoIndex} of ${totalPhotos} from the photo gallery.`;

// Prepare props for layout wrapper
const layoutWrapperProps = {
  title: pageTitle,
  description: pageDescription,
  ...passedLayoutProps
};

// Try to load layout wrapper if provided (path is already resolved by integration)
let LayoutComponent = null;
if (passedLayoutWrapper) {
  try {
    // Use /* @vite-ignore */ to suppress Vite analysis warning  
    const layoutModule = await import(/* @vite-ignore */ passedLayoutWrapper);
    LayoutComponent = layoutModule.default || layoutModule;
  } catch (error) {
    console.warn(`[astro-photostream] Failed to load layout component: ${passedLayoutWrapper}`, error);
    LayoutComponent = null;
  }
}
---

{LayoutComponent ? (
  <LayoutComponent {...layoutWrapperProps}>
    <div class="aps-container">
      <!-- Navigation Header -->
      <nav class="aps-photo-nav">
        <a href="/photos" class="aps-nav-link">
          ‚Üê Back to Gallery
        </a>
        
        <span class="aps-photo-counter">{photoIndex} of {totalPhotos}</span>
        
        <div class="aps-photo-controls">
          {prevPhoto ? (
            <a 
              href={`/photos/${prevPhoto.slug}`} 
              class="aps-control-link" 
              aria-label="Previous photo"
            >
              ‚Üê Previous
            </a>
          ) : (
            <span class="aps-control-link aps-control-link--disabled">
              ‚Üê Previous
            </span>
          )}
          
          {nextPhoto ? (
            <a 
              href={`/photos/${nextPhoto.slug}`} 
              class="aps-control-link" 
              aria-label="Next photo"
            >
              Next ‚Üí
            </a>
          ) : (
            <span class="aps-control-link aps-control-link--disabled">
              Next ‚Üí
            </span>
          )}
        </div>
      </nav>
      
      <!-- Photo Display -->
      <section class="aps-section">
        <PhotoCard 
          photo={photoMetadata}
          showTags={config.gallery.enableTags}
          priority={true}
          variant="hero"
        />
      </section>

      <!-- Location Map -->
      {photoMetadata.location?.latitude && photoMetadata.location?.longitude && (
        <section class="aps-section">
          <h2 class="aps-section-title">Photo Location</h2>
          <div class="aps-map-container">
            <MapImage 
              photo={photoMetadata}
              width={800}
              height={400}
            />
          </div>
          {photoMetadata.location?.name && (
            <p class="aps-location-name">üìç {photoMetadata.location.name}</p>
          )}
        </section>
      )}

      <!-- Metadata Details -->
      <section class="aps-section">
        <h2 class="aps-section-title">Photo Details</h2>
        <div class="aps-metadata-grid">
          {photoMetadata.camera && (
            <div class="aps-metadata-card">
              <strong class="aps-metadata-label">Camera:</strong>
              <p class="aps-metadata-value">{photoMetadata.camera}</p>
            </div>
          )}
          {photoMetadata.lens && (
            <div class="aps-metadata-card">
              <strong class="aps-metadata-label">Lens:</strong>
              <p class="aps-metadata-value">{photoMetadata.lens}</p>
            </div>
          )}
          {photoMetadata.settings && (
            <div class="aps-metadata-card">
              <strong class="aps-metadata-label">Settings:</strong>
              <div class="aps-settings-list">
                {photoMetadata.settings.aperture && <span>f/{photoMetadata.settings.aperture}</span>}
                {photoMetadata.settings.shutterSpeed && <span>{photoMetadata.settings.shutterSpeed}s</span>}
                {photoMetadata.settings.iso && <span>ISO {photoMetadata.settings.iso}</span>}
                {photoMetadata.settings.focalLength && <span>{photoMetadata.settings.focalLength}mm</span>}
              </div>
            </div>
          )}
          <div class="aps-metadata-card">
            <strong class="aps-metadata-label">Published:</strong>
            <p class="aps-metadata-value">{photoMetadata.publishDate.toLocaleDateString()}</p>
          </div>
        </div>
      </section>

      <!-- Related Photos / Navigation Footer -->
      <section class="aps-section">
        <h2 class="aps-section-title">Continue Exploring</h2>
        <div class="aps-related-grid">
          {prevPhoto ? (
            <a 
              href={`/photos/${prevPhoto.slug}`} 
              class="aps-related-photo"
            >
              <img 
                src={prevPhoto.coverImage} 
                alt={prevPhoto.title} 
                loading="lazy" 
                class="aps-related-image"
              />
              <div class="aps-related-content">
                <span class="aps-related-label">‚Üê Previous</span>
                <p class="aps-related-title">{prevPhoto.title}</p>
              </div>
            </a>
          ) : (
            <div></div>
          )}
          
          <div class="aps-related-center">
            <a 
              href="/photos" 
              class="aps-gallery-link"
            >
              <span class="aps-gallery-text">View All Photos</span>
              <span class="aps-gallery-count">({totalPhotos} total)</span>
            </a>
          </div>
          
          {nextPhoto ? (
            <a 
              href={`/photos/${nextPhoto.slug}`} 
              class="aps-related-photo"
            >
              <img 
                src={nextPhoto.coverImage} 
                alt={nextPhoto.title} 
                loading="lazy" 
                class="aps-related-image"
              />
              <div class="aps-related-content">
                <span class="aps-related-label">Next ‚Üí</span>
                <p class="aps-related-title">{nextPhoto.title}</p>
              </div>
            </a>
          ) : (
            <div></div>
          )}
        </div>
      </section>
    </div>
  </LayoutComponent>
) : (
  <!-- Minimal fallback when no layout wrapper is provided -->
  <html lang="en">
    <head>
      <meta charset="utf-8" />
      <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
      <meta name="viewport" content="width=device-width" />
      <meta name="generator" content={Astro.generator} />
      <title>{pageTitle}</title>
      <meta name="description" content={pageDescription} />
      
      <!-- Open Graph -->
      <meta property="og:title" content={pageTitle} />
      <meta property="og:description" content={pageDescription} />
      {photoMetadata.coverImage && (
        <meta property="og:image" content={photoMetadata.coverImage} />
      )}
    </head>
    <body>
      <main class="photo-page">
        <!-- Navigation Header -->
        <nav class="photo-nav">
          <div class="nav-left">
            <a href="/photos" class="back-link">‚Üê Back to Gallery</a>
          </div>
          <div class="nav-center">
            <span class="photo-counter">{photoIndex} of {totalPhotos}</span>
          </div>
          <div class="nav-right">
            {/* Photo Navigation */}
            <div class="photo-navigation">
              {prevPhoto ? (
                <a href={`/photos/${prevPhoto.slug}`} class="nav-photo prev" aria-label="Previous photo">
                  <span class="nav-label">‚Üê Previous</span>
                  <span class="nav-title">{prevPhoto.title}</span>
                </a>
              ) : (
                <div class="nav-photo disabled">
                  <span class="nav-label">‚Üê Previous</span>
                </div>
              )}
              
              {nextPhoto ? (
                <a href={`/photos/${nextPhoto.slug}`} class="nav-photo next" aria-label="Next photo">
                  <span class="nav-label">Next ‚Üí</span>
                  <span class="nav-title">{nextPhoto.title}</span>
                </a>
              ) : (
                <div class="nav-photo disabled">
                  <span class="nav-label">Next ‚Üí</span>
                </div>
              )}
            </div>
          </div>
        </nav>
        
        <!-- Photo Display -->
        <section class="photo-section">
          <PhotoCard 
            photo={photoMetadata}
            showTags={config.gallery.enableTags}
            priority={true}
            variant="hero"
          />
        </section>

        <!-- Location Map -->
        {photoMetadata.location?.latitude && photoMetadata.location?.longitude && (
          <section class="location-section">
            <h2 class="section-title">Photo Location</h2>
            <div class="aps-map-container-inner">
              <MapImage 
                photo={photoMetadata}
                width={800}
                height={400}
              />
            </div>
            {photoMetadata.location?.name && (
              <p class="location-name">üìç {photoMetadata.location.name}</p>
            )}
          </section>
        )}

        <!-- Metadata Details -->
        <section class="metadata-section">
          <h2 class="section-title">Photo Details</h2>
          <div class="aps-metadata-grid-inner">
            {photoMetadata.camera && (
              <div class="metadata-item">
                <strong>Camera:</strong> {photoMetadata.camera}
              </div>
            )}
            {photoMetadata.lens && (
              <div class="metadata-item">
                <strong>Lens:</strong> {photoMetadata.lens}
              </div>
            )}
            {photoMetadata.settings && (
              <div class="metadata-item">
                <strong>Settings:</strong>
                <div class="settings-details">
                  {photoMetadata.settings.aperture && <span>f/{photoMetadata.settings.aperture}</span>}
                  {photoMetadata.settings.shutterSpeed && <span>{photoMetadata.settings.shutterSpeed}s</span>}
                  {photoMetadata.settings.iso && <span>ISO {photoMetadata.settings.iso}</span>}
                  {photoMetadata.settings.focalLength && <span>{photoMetadata.settings.focalLength}mm</span>}
                </div>
              </div>
            )}
            <div class="metadata-item">
              <strong>Published:</strong> {photoMetadata.publishDate.toLocaleDateString()}
            </div>
          </div>
        </section>

        <!-- Related Photos / Navigation Footer -->
        <section class="related-section">
          <h2 class="section-title">Continue Exploring</h2>
          <div class="related-navigation">
            {prevPhoto && (
              <a href={`/photos/${prevPhoto.slug}`} class="related-photo">
                <img src={prevPhoto.coverImage} alt={prevPhoto.title} loading="lazy" />
                <div class="related-info">
                  <span class="related-label">‚Üê Previous</span>
                  <span class="related-title">{prevPhoto.title}</span>
                </div>
              </a>
            )}
            
            <a href="/photos" class="back-to-gallery">
              <span class="back-label">View All Photos</span>
              <span class="back-count">({totalPhotos} total)</span>
            </a>
            
            {nextPhoto && (
              <a href={`/photos/${nextPhoto.slug}`} class="related-photo next">
                <img src={nextPhoto.coverImage} alt={nextPhoto.title} loading="lazy" />
                <div class="related-info">
                  <span class="related-label">Next ‚Üí</span>
                  <span class="related-title">{nextPhoto.title}</span>
                </div>
              </a>
            )}
          </div>
        </section>
      </main>
      
      <style>
        /* Minimal styling for fallback mode */
        .photo-page {
          max-width: 1200px;
          margin: 0 auto;
          padding: 1rem;
        }
        
        .photo-nav {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 1rem 0;
          border-bottom: 1px solid #e5e7eb;
          margin-bottom: 2rem;
        }
        
        .back-link {
          color: #3b82f6;
          text-decoration: none;
        }
        
        .photo-counter {
          color: #6b7280;
          font-size: 0.9rem;
        }
        
        .section-title {
          font-size: 1.5rem;
          margin: 2rem 0 1rem 0;
          color: #1f2937;
        }
        
        .metadata-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 1rem;
          margin-top: 1rem;
        }
        
        .metadata-item {
          padding: 1rem;
          background: #f9fafb;
          border-radius: 0.5rem;
        }
        
        .settings-details {
          display: flex;
          gap: 1rem;
          margin-top: 0.5rem;
          font-family: monospace;
        }
        
        .related-navigation {
          display: grid;
          grid-template-columns: 1fr auto 1fr;
          gap: 2rem;
          align-items: center;
          margin-top: 2rem;
        }
        
        .related-photo img {
          width: 120px;
          height: 80px;
          object-fit: cover;
          border-radius: 0.375rem;
        }
        
        .back-to-gallery {
          text-align: center;
          text-decoration: none;
          color: #3b82f6;
          padding: 1rem;
          background: #f3f4f6;
          border-radius: 0.5rem;
        }
        
        @media (prefers-color-scheme: dark) {
          .section-title {
            color: #f9fafb;
          }
          .metadata-item {
            background: #374151;
            color: #f9fafb;
          }
          .photo-nav {
            border-bottom-color: #4b5563;
          }
          .back-to-gallery {
            background: #374151;
            color: #f9fafb;
          }
        }
      </style>
    </body>
  </html>
)}

<style>
/* Astro PhotoStream - Individual Photo Page - Scoped styles with aps- prefix */
.aps-container {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem 1rem;
}

.aps-photo-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
  margin-bottom: 2rem;
}

.aps-nav-link {
  color: #6b7280;
  text-decoration: none;
  transition: color 0.2s ease;
}

.aps-nav-link:hover {
  color: #111827;
}

.aps-photo-counter {
  font-size: 0.875rem;
  color: #9ca3af;
}

.aps-photo-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.aps-control-link {
  color: #6b7280;
  text-decoration: none;
  transition: color 0.2s ease;
}

.aps-control-link:hover:not(.aps-control-link--disabled) {
  color: #111827;
}

.aps-control-link--disabled {
  color: #9ca3af;
  cursor: not-allowed;
}

.aps-section {
  margin-bottom: 3rem;
}

.aps-section-title {
  font-size: 1.5rem;
  font-weight: bold;
  color: #111827;
  margin-bottom: 1.5rem;
}

.aps-map-container,
.aps-map-container-inner {
  border-radius: 0.5rem;
  overflow: hidden;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  margin-bottom: 1rem;
}

.aps-location-name {
  text-align: center;
  color: #6b7280;
}

.aps-metadata-grid,
.aps-metadata-grid-inner {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

.aps-metadata-card {
  padding: 1rem;
  background: #f9fafb;
  border-radius: 0.5rem;
}

.aps-metadata-label {
  color: #111827;
  font-weight: 600;
}

.aps-metadata-value {
  color: #6b7280;
  margin-top: 0.25rem;
}

.aps-settings-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.25rem;
  font-size: 0.875rem;
  color: #6b7280;
  font-family: ui-monospace, SFMono-Regular, "SF Mono", monospace;
}

.aps-related-grid {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 1.5rem;
  align-items: center;
}

.aps-related-photo {
  display: block;
  background: #ffffff;
  border-radius: 0.5rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  text-decoration: none;
  transition: box-shadow 0.2s ease, transform 0.2s ease;
}

.aps-related-photo:hover {
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.aps-related-image {
  width: 100%;
  height: 128px;
  object-fit: cover;
  transition: transform 0.2s ease;
}

.aps-related-photo:hover .aps-related-image {
  transform: scale(1.05);
}

.aps-related-content {
  padding: 1rem;
}

.aps-related-label {
  font-size: 0.875rem;
  color: #9ca3af;
}

.aps-related-title {
  font-weight: 500;
  color: #111827;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-top: 0.25rem;
}

.aps-related-center {
  text-align: center;
}

.aps-gallery-link {
  display: inline-flex;
  align-items: center;
  padding: 0.75rem 1.5rem;
  background: #f3f4f6;
  color: #374151;
  text-decoration: none;
  border-radius: 0.375rem;
  transition: background-color 0.2s ease, color 0.2s ease;
}

.aps-gallery-link:hover {
  background: #e5e7eb;
  color: #111827;
}

.aps-gallery-text {
  font-weight: 500;
}

.aps-gallery-count {
  margin-left: 0.5rem;
  font-size: 0.875rem;
  color: #9ca3af;
}

/* Responsive design */
@media (min-width: 640px) {
  .aps-container {
    padding: 2rem 1.5rem;
  }
}

@media (min-width: 768px) {
  .aps-related-grid {
    gap: 2rem;
  }
}

@media (min-width: 1024px) {
  .aps-container {
    padding: 2rem 2rem;
  }
  
  .aps-metadata-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 768px) {
  .aps-photo-controls {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .aps-related-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .aps-related-center {
    order: -1;
  }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
  .aps-nav-link {
    color: #9ca3af;
  }
  
  .aps-nav-link:hover {
    color: #f9fafb;
  }
  
  .aps-photo-counter {
    color: #6b7280;
  }
  
  .aps-photo-nav {
    border-bottom-color: #4b5563;
  }
  
  .aps-control-link {
    color: #9ca3af;
  }
  
  .aps-control-link:hover:not(.aps-control-link--disabled) {
    color: #f9fafb;
  }
  
  .aps-control-link--disabled {
    color: #6b7280;
  }
  
  .aps-section-title {
    color: #f9fafb;
  }
  
  .aps-location-name {
    color: #9ca3af;
  }
  
  .aps-metadata-card {
    background: #374151;
  }
  
  .aps-metadata-label {
    color: #f9fafb;
  }
  
  .aps-metadata-value {
    color: #9ca3af;
  }
  
  .aps-settings-list {
    color: #9ca3af;
  }
  
  .aps-related-photo {
    background: #1f2937;
  }
  
  .aps-related-title {
    color: #f9fafb;
  }
  
  .aps-gallery-link {
    background: #374151;
    color: #f9fafb;
  }
  
  .aps-gallery-link:hover {
    background: #4b5563;
  }
  
  .aps-gallery-count {
    color: #9ca3af;
  }
}
</style>